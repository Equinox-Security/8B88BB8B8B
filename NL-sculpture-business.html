<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kleisculptuur Bedrijfsbeheer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f7f7f7;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #ececec;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            background: #f7f7f7;
            font-weight: 600;
            color: #333;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-in-progress {
            background: #cfe2ff;
            color: #084298;
        }

        .badge-completed {
            background: #d1e7dd;
            color: #0f5132;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .modal-footer {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 5px 10px;
            text-decoration: underline;
        }

        .action-btn:hover {
            color: #5568d3;
        }

        .delete-btn {
            color: #dc3545;
        }

        .chart-container {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #cfe2ff;
            color: #084298;
            border-left: 4px solid #0d6efd;
        }

        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #28a745;
        }

        .copy-area {
            background: #f7f7f7;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            margin-top: 15px;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .stat-card .number {
                font-size: 28px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóø Kleisculptuur Bedrijfsbeheer</h1>
            <p>Beheer bestellingen, klanten en laat uw creatieve bedrijf groeien</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('orders')">üì¶ Bestellingen</button>
            <button class="tab" onclick="switchTab('customers')">üë• Klanten</button>
            <button class="tab" onclick="switchTab('materials')">üì¶ Materialen</button>
            <button class="tab" onclick="switchTab('analytics')">üìà Analyses</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Instellingen</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Totaal Bestellingen</h3>
                        <div class="number" id="stat-total-orders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Actieve Bestellingen</h3>
                        <div class="number" id="stat-active-orders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Totale Omzet</h3>
                        <div class="number" id="stat-revenue">‚Ç¨0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Totaal Klanten</h3>
                        <div class="number" id="stat-customers">0</div>
                    </div>
                </div>

                <h2 style="margin-bottom: 15px;">Recente Bestellingen</h2>
                <div id="recent-orders-list"></div>
            </div>

            <!-- ORDERS TAB -->
            <div id="orders" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Alle Bestellingen</h2>
                    <button class="btn" onclick="openOrderModal()">+ Nieuwe Bestelling</button>
                </div>
                
                <input type="text" class="search-box" id="order-search" placeholder="Zoek bestellingen..." onkeyup="filterOrders()">
                
                <div style="margin-bottom: 15px;">
                    <label>Filter op status: </label>
                    <select onchange="filterOrders()" id="status-filter" style="padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
                        <option value="all">Alle</option>
                        <option value="pending">In afwachting</option>
                        <option value="in-progress">In bewerking</option>
                        <option value="completed">Voltooid</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>Bestelnr.</th>
                                <th>Klant</th>
                                <th>Omschrijving</th>
                                <th>Status</th>
                                <th>Besteldatum</th>
                                <th>Prijs</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- CUSTOMERS TAB -->
            <div id="customers" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Klantenlijst</h2>
                    <button class="btn" onclick="openCustomerModal()">+ Nieuwe Klant</button>
                </div>

                <input type="text" class="search-box" id="customer-search" placeholder="Zoek klanten..." onkeyup="filterCustomers()">

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Naam</th>
                                <th>E-mail</th>
                                <th>Telefoon</th>
                                <th>Locatie</th>
                                <th>Bestellingen</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- MATERIALS TAB -->
            <div id="materials" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Materiaalvoorraad</h2>
                    <button class="btn" onclick="openMaterialModal()">+ Materiaal Toevoegen</button>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h3>Totale Waarde</h3>
                        <div class="number" id="stat-inventory-value">‚Ç¨0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                        <h3>Lage Voorraad</h3>
                        <div class="number" id="stat-low-stock">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);">
                        <h3>Totaal Artikelen</h3>
                        <div class="number" id="stat-total-materials">0</div>
                    </div>
                </div>

                <input type="text" class="search-box" id="material-search" placeholder="Zoek materialen..." onkeyup="filterMaterials()">

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Materiaalnaam</th>
                                <th>Categorie</th>
                                <th>Hoeveelheid</th>
                                <th>Eenheid</th>
                                <th>Kosten/Eenheid</th>
                                <th>Totale Waarde</th>
                                <th>Status</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="materials-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="analytics" class="tab-content">
                <h2>Verkoopanalyses</h2>
                
                <div class="chart-container">
                    <h3>Maandelijkse Omzet (Jaarvergelijking)</h3>
                    <canvas id="revenue-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Bestellingen per Status</h3>
                    <canvas id="status-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Maandelijks Bestelvolume</h3>
                    <canvas id="orders-chart"></canvas>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <h2>Instellingen & Hulpmiddelen</h2>

                <div style="margin-top: 30px;">
                    <h3>üì§ Gegevens Exporteren (Opslaan naar Bestand)</h3>
                    <div class="alert alert-info">
                        <strong>Belangrijk:</strong> Uw gegevens worden lokaal in uw browser opgeslagen. Exporteer regelmatig om te synchroniseren tussen apparaten!
                    </div>
                    <button class="btn" onclick="exportData()">üì• Backup Exporteren (JSON)</button>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="margin-left: 10px;">üìä Exporteren als CSV</button>
                    <p style="color: #666; margin-top: 10px; font-size: 14px;">
                        <strong>Gebruik dit om:</strong> Gegevens over te zetten naar een ander apparaat, backups te maken, of op te slaan voordat u browsergegevens wist
                    </p>
                </div>

                <div style="margin-top: 30px;">
                    <h3>üì• Gegevens Importeren (Laden uit Bestand)</h3>
                    <p style="color: #666; margin-bottom: 10px;">Upload een backupbestand om gegevens te herstellen of samen te voegen</p>
                    <input type="file" id="import-file" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="importData()">üìÇ Backup Importeren</button>
                </div>

                <div style="margin-top: 40px;">
                    <h3>üìã Bestelinstructies Sjabloon</h3>
                    <p style="color: #666; margin-bottom: 10px;">Kopieer en plak dit in berichten/e-mails naar klanten:</p>
                    <div class="form-group">
                        <textarea id="order-template" rows="8">
üé® Hoe u uw op maat gemaakte kleisculptuur kunt bestellen:

1. Stuur mij een duidelijke foto van de persoon/personen die u wilt laten beeldhouwen
2. Laat mij weten welk formaat uw voorkeur heeft
3. Kies uw lijststijl (indien van toepassing)
4. Huidige levertijd: 2-3 weken
5. Prijzen vanaf ‚Ç¨[UW PRIJS]

Betaling geaccepteerd via: [iDEAL/PayPal/Tikkie/etc]

Vragen? Vraag gerust! üòä
                        </textarea>
                    </div>
                    <button class="btn" onclick="copyTemplate()">Sjabloon Kopi√´ren</button>
                    <button class="btn btn-secondary" onclick="saveTemplate()" style="margin-left: 10px;">Wijzigingen Opslaan</button>
                </div>

                <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                    <h3 style="color: #dc3545;">‚ö†Ô∏è Gevarenzone</h3>
                    <p style="color: #666; margin: 10px 0;">Dit verwijdert alle gegevens permanent. Zorg dat u eerst een backup heeft!</p>
                    <button class="btn btn-danger" onclick="clearAllData()">Alle Gegevens Wissen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDER MODAL -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="order-modal-title">Nieuwe Bestelling</h2>
            </div>
            <form id="order-form" onsubmit="saveOrder(event)">
                <input type="hidden" id="order-id">
                
                <div class="form-group">
                    <label>Klant *</label>
                    <select id="order-customer" required>
                        <option value="">Selecteer klant...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Omschrijving *</label>
                    <textarea id="order-description" required placeholder="bijv. Familiesculptuur met 2 volwassenen en 1 kind"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Prijs (‚Ç¨) *</label>
                        <input type="number" id="order-price" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>Materiaalkosten (‚Ç¨)</label>
                        <input type="number" id="order-material-cost" step="0.01" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="order-status" required>
                            <option value="pending">In afwachting</option>
                            <option value="in-progress">In bewerking</option>
                            <option value="completed">Voltooid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Besteldatum *</label>
                        <input type="date" id="order-date" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Voltooiingsdatum</label>
                    <input type="date" id="order-completion-date">
                </div>

                <div class="form-group">
                    <label>Notities</label>
                    <textarea id="order-notes" placeholder="Speciale verzoeken of details..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Annuleren</button>
                    <button type="submit" class="btn">Bestelling Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CUSTOMER MODAL -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customer-modal-title">Nieuwe Klant</h2>
            </div>
            <form id="customer-form" onsubmit="saveCustomer(event)">
                <input type="hidden" id="customer-id">
                
                <div class="form-group">
                    <label>Volledige Naam *</label>
                    <input type="text" id="customer-name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="customer-email">
                    </div>

                    <div class="form-group">
                        <label>Telefoon</label>
                        <input type="tel" id="customer-phone">
                    </div>
                </div>

                <div class="form-group">
                    <label>Adres</label>
                    <input type="text" id="customer-address">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Plaats</label>
                        <input type="text" id="customer-city">
                    </div>

                    <div class="form-group">
                        <label>Provincie</label>
                        <input type="text" id="customer-state" placeholder="NH">
                    </div>
                </div>

                <div class="form-group">
                    <label>Postcode</label>
                    <input type="text" id="customer-zip">
                </div>

                <div class="form-group">
                    <label>Notities</label>
                    <textarea id="customer-notes" placeholder="Hoe ze u gevonden hebben, voorkeuren, etc..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Annuleren</button>
                    <button type="submit" class="btn">Klant Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MATERIAL MODAL -->
    <div id="material-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="material-modal-title">Nieuw Materiaal</h2>
            </div>
            <form id="material-form" onsubmit="saveMaterial(event)">
                <input type="hidden" id="material-id">
                
                <div class="form-group">
                    <label>Materiaalnaam *</label>
                    <input type="text" id="material-name" required placeholder="bijv. Polymeerklei - Wit">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Categorie *</label>
                        <select id="material-category" required>
                            <option value="">Selecteer...</option>
                            <option value="clay">Klei</option>
                            <option value="frames">Lijsten</option>
                            <option value="paint">Verf/Afwerking</option>
                            <option value="tools">Gereedschap</option>
                            <option value="packaging">Verpakking</option>
                            <option value="other">Overig</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Eenheid *</label>
                        <select id="material-unit" required>
                            <option value="">Selecteer...</option>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="st">Stuks (st)</option>
                            <option value="dozen">Dozen</option>
                            <option value="flessen">Flessen</option>
                            <option value="rollen">Rollen</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Voorraad *</label>
                        <input type="number" id="material-quantity" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>Bestelniveau</label>
                        <input type="number" id="material-reorder-level" step="0.01" placeholder="Waarschuwing wanneer onder dit niveau">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Kosten per Eenheid (‚Ç¨) *</label>
                        <input type="number" id="material-cost" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>Leverancier</label>
                        <input type="text" id="material-supplier" placeholder="Waar u het koopt">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notities</label>
                    <textarea id="material-notes" placeholder="Link naar product, notities, etc..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMaterialModal()">Annuleren</button>
                    <button type="submit" class="btn">Materiaal Opslaan</button>
                </div>
            </form>
        </div>
    </div>
	
    <script>
        // Gegevensopslag
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let materials = JSON.parse(localStorage.getItem('materials')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            orderTemplate: document.getElementById('order-template').value
        };

        // Initialisatie
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderTemplate();
            updateDashboard();
            renderOrders();
            renderCustomers();
            renderMaterials();
            updateCustomerDropdown();
            setDefaultDate();
            renderCharts();
        });

        // Tab wisselen
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'analytics') {
                renderCharts();
            }
        }

        // Hulpfunctie voor Nederlands bedragformaat
        function formatCurrency(amount) {
            return '‚Ç¨' + parseFloat(amount).toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Dashboard functies
        function updateDashboard() {
            const totalOrders = orders.length;
            const activeOrders = orders.filter(o => o.status !== 'completed').length;
            const totalRevenue = orders.reduce((sum, o) => sum + parseFloat(o.price || 0), 0);
            const totalCustomers = customers.length;

            document.getElementById('stat-total-orders').textContent = totalOrders;
            document.getElementById('stat-active-orders').textContent = activeOrders;
            document.getElementById('stat-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('stat-customers').textContent = totalCustomers;

            renderRecentOrders();
        }

        function renderRecentOrders() {
            const recentOrders = [...orders]
                .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
                .slice(0, 5);

            const container = document.getElementById('recent-orders-list');
            
            if (recentOrders.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nog geen bestellingen. Maak uw eerste bestelling aan om te beginnen!</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Klant</th>
                            <th>Omschrijving</th>
                            <th>Status</th>
                            <th>Datum</th>
                            <th>Prijs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentOrders.map(order => {
                            const customer = customers.find(c => c.id === order.customerId);
                            return `
                                <tr>
                                    <td>${customer ? customer.name : 'Onbekend'}</td>
                                    <td>${order.description}</td>
                                    <td><span class="badge badge-${order.status}">${getStatusLabel(order.status)}</span></td>
                                    <td>${formatDate(order.orderDate)}</td>
                                    <td>${formatCurrency(order.price)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Status label helper
        function getStatusLabel(status) {
            const labels = {
                'pending': 'In afwachting',
                'in-progress': 'In bewerking',
                'completed': 'Voltooid'
            };
            return labels[status] || status;
        }

        // Bestelling functies
        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nog geen bestellingen. Klik op "Nieuwe Bestelling" om er een aan te maken!</td></tr>';
                return;
            }

            const sortedOrders = [...orders].sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            tbody.innerHTML = sortedOrders.map(order => {
                const customer = customers.find(c => c.id === order.customerId);
                return `
                    <tr>
                        <td>#${order.id.slice(0, 8)}</td>
                        <td>${customer ? customer.name : 'Onbekend'}</td>
                        <td>${order.description}</td>
                        <td><span class="badge badge-${order.status}">${getStatusLabel(order.status)}</span></td>
                        <td>${formatDate(order.orderDate)}</td>
                        <td>${formatCurrency(order.price)}</td>
                        <td>
                            <button class="action-btn" onclick="editOrder('${order.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteOrder('${order.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterOrders() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            const filtered = orders.filter(order => {
                const customer = customers.find(c => c.id === order.customerId);
                const customerName = customer ? customer.name.toLowerCase() : '';
                const matchesSearch = customerName.includes(searchTerm) || 
                                    order.description.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            const tbody = document.getElementById('orders-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Geen bestellingen gevonden.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(order => {
                const customer = customers.find(c => c.id === order.customerId);
                return `
                    <tr>
                        <td>#${order.id.slice(0, 8)}</td>
                        <td>${customer ? customer.name : 'Onbekend'}</td>
                        <td>${order.description}</td>
                        <td><span class="badge badge-${order.status}">${getStatusLabel(order.status)}</span></td>
                        <td>${formatDate(order.orderDate)}</td>
                        <td>${formatCurrency(order.price)}</td>
                        <td>
                            <button class="action-btn" onclick="editOrder('${order.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteOrder('${order.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ‚úÖ FIXED: Explicitly clear hidden ID field
        function openOrderModal(orderId = null) {
            const modal = document.getElementById('order-modal');
            const form = document.getElementById('order-form');
            form.reset();
            
            // ‚úÖ FIX: Always clear the hidden ID field first!
            document.getElementById('order-id').value = '';
            
            setDefaultDate();
            updateCustomerDropdown();

            if (orderId) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    document.getElementById('order-modal-title').textContent = 'Bestelling Bewerken';
                    document.getElementById('order-id').value = order.id;
                    document.getElementById('order-customer').value = order.customerId;
                    document.getElementById('order-description').value = order.description;
                    document.getElementById('order-price').value = order.price;
                    document.getElementById('order-material-cost').value = order.materialCost || 0;
                    document.getElementById('order-status').value = order.status;
                    document.getElementById('order-date').value = order.orderDate;
                    document.getElementById('order-completion-date').value = order.completionDate || '';
                    document.getElementById('order-notes').value = order.notes || '';
                }
            } else {
                document.getElementById('order-modal-title').textContent = 'Nieuwe Bestelling';
            }

            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            // ‚úÖ FIX: Clear the hidden ID field when closing
            document.getElementById('order-id').value = '';
        }

        // ‚úÖ FIXED: Added index validation
        function saveOrder(event) {
            event.preventDefault();

            const orderId = document.getElementById('order-id').value;
            const orderData = {
                id: orderId || generateId(),
                customerId: document.getElementById('order-customer').value,
                description: document.getElementById('order-description').value,
                price: document.getElementById('order-price').value,
                materialCost: document.getElementById('order-material-cost').value || 0,
                status: document.getElementById('order-status').value,
                orderDate: document.getElementById('order-date').value,
                completionDate: document.getElementById('order-completion-date').value,
                notes: document.getElementById('order-notes').value
            };

            if (orderId) {
                const index = orders.findIndex(o => o.id === orderId);
                // ‚úÖ FIX: Check if index is valid
                if (index !== -1) {
                    orders[index] = orderData;
                } else {
                    // ID was set but not found - treat as new
                    orderData.id = generateId();
                    orders.push(orderData);
                }
            } else {
                orders.push(orderData);
            }

            localStorage.setItem('orders', JSON.stringify(orders));
            closeOrderModal();
            renderOrders();
            updateDashboard();
            renderCharts();
        }

        function editOrder(orderId) {
            openOrderModal(orderId);
        }

        function deleteOrder(orderId) {
            if (confirm('Weet u zeker dat u deze bestelling wilt verwijderen?')) {
                orders = orders.filter(o => o.id !== orderId);
                localStorage.setItem('orders', JSON.stringify(orders));
                renderOrders();
                updateDashboard();
                renderCharts();
            }
        }

        // Klant functies
        function renderCustomers() {
            const tbody = document.getElementById('customers-tbody');
            
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">Nog geen klanten. Klik op "Nieuwe Klant" om er een toe te voegen!</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => {
                const customerOrders = orders.filter(o => o.customerId === customer.id).length;
                const location = [customer.city, customer.state].filter(Boolean).join(', ') || 'N.v.t.';
                
                return `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.email || 'N.v.t.'}</td>
                        <td>${customer.phone || 'N.v.t.'}</td>
                        <td>${location}</td>
                        <td>${customerOrders}</td>
                        <td>
                            <button class="action-btn" onclick="editCustomer('${customer.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteCustomer('${customer.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            
            const filtered = customers.filter(customer => {
                return customer.name.toLowerCase().includes(searchTerm) ||
                       (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                       (customer.phone && customer.phone.includes(searchTerm)) ||
                       (customer.city && customer.city.toLowerCase().includes(searchTerm));
            });

            const tbody = document.getElementById('customers-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">Geen klanten gevonden.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(customer => {
                const customerOrders = orders.filter(o => o.customerId === customer.id).length;
                const location = [customer.city, customer.state].filter(Boolean).join(', ') || 'N.v.t.';
                
                return `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.email || 'N.v.t.'}</td>
                        <td>${customer.phone || 'N.v.t.'}</td>
                        <td>${location}</td>
                        <td>${customerOrders}</td>
                        <td>
                            <button class="action-btn" onclick="editCustomer('${customer.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteCustomer('${customer.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ‚úÖ FIXED: Explicitly clear hidden ID field
        function openCustomerModal(customerId = null) {
            const modal = document.getElementById('customer-modal');
            const form = document.getElementById('customer-form');
            form.reset();
            
            // ‚úÖ FIX: Always clear the hidden ID field first!
            document.getElementById('customer-id').value = '';

            if (customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('customer-modal-title').textContent = 'Klant Bewerken';
                    document.getElementById('customer-id').value = customer.id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-email').value = customer.email || '';
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-address').value = customer.address || '';
                    document.getElementById('customer-city').value = customer.city || '';
                    document.getElementById('customer-state').value = customer.state || '';
                    document.getElementById('customer-zip').value = customer.zip || '';
                    document.getElementById('customer-notes').value = customer.notes || '';
                }
            } else {
                document.getElementById('customer-modal-title').textContent = 'Nieuwe Klant';
            }

            modal.classList.add('active');
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.remove('active');
            // ‚úÖ FIX: Clear the hidden ID field when closing
            document.getElementById('customer-id').value = '';
        }

        // ‚úÖ FIXED: Added index validation
        function saveCustomer(event) {
            event.preventDefault();

            const customerId = document.getElementById('customer-id').value;
            const customerData = {
                id: customerId || generateId(),
                name: document.getElementById('customer-name').value,
                email: document.getElementById('customer-email').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value,
                city: document.getElementById('customer-city').value,
                state: document.getElementById('customer-state').value,
                zip: document.getElementById('customer-zip').value,
                notes: document.getElementById('customer-notes').value
            };

            if (customerId) {
                const index = customers.findIndex(c => c.id === customerId);
                // ‚úÖ FIX: Check if index is valid
                if (index !== -1) {
                    customers[index] = customerData;
                } else {
                    // ID was set but not found - treat as new
                    customerData.id = generateId();
                    customers.push(customerData);
                }
            } else {
                customers.push(customerData);
            }

            localStorage.setItem('customers', JSON.stringify(customers));
            closeCustomerModal();
            renderCustomers();
            updateCustomerDropdown();
            updateDashboard();
        }

        function editCustomer(customerId) {
            openCustomerModal(customerId);
        }

        function deleteCustomer(customerId) {
            const hasOrders = orders.some(o => o.customerId === customerId);
            
            if (hasOrders) {
                alert('Kan klant met bestaande bestellingen niet verwijderen. Verwijder eerst hun bestellingen.');
                return;
            }

            if (confirm('Weet u zeker dat u deze klant wilt verwijderen?')) {
                customers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('customers', JSON.stringify(customers));
                renderCustomers();
                updateCustomerDropdown();
                updateDashboard();
            }
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('order-customer');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Selecteer klant...</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Materiaal functies
        function renderMaterials() {
            const tbody = document.getElementById('materials-tbody');
            
            if (materials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Nog geen materialen. Klik op "Materiaal Toevoegen" om voorraad bij te houden!</td></tr>';
                updateMaterialStats();
                return;
            }

            tbody.innerHTML = materials.map(material => {
                const totalValue = (parseFloat(material.quantity) * parseFloat(material.cost)).toFixed(2);
                const isLowStock = material.reorderLevel && parseFloat(material.quantity) <= parseFloat(material.reorderLevel);
                
                return `
                    <tr>
                        <td><strong>${material.name}</strong></td>
                        <td>${getCategoryLabel(material.category)}</td>
                        <td>${material.quantity.toString().replace('.', ',')}</td>
                        <td>${getUnitLabel(material.unit)}</td>
                        <td>${formatCurrency(material.cost)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td>
                            ${isLowStock ? '<span class="badge badge-pending">‚ö†Ô∏è Lage Voorraad</span>' : '<span class="badge badge-completed">‚úì Op Voorraad</span>'}
                        </td>
                        <td>
                            <button class="action-btn" onclick="editMaterial('${material.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteMaterial('${material.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateMaterialStats();
        }

        // Categorie label helper
        function getCategoryLabel(category) {
            const labels = {
                'clay': 'Klei',
                'frames': 'Lijsten',
                'paint': 'Verf/Afwerking',
                'tools': 'Gereedschap',
                'packaging': 'Verpakking',
                'other': 'Overig'
            };
            return labels[category] || category;
        }

        // Eenheid label helper
        function getUnitLabel(unit) {
            const labels = {
                'kg': 'kg',
                'g': 'g',
                'lbs': 'kg',
                'oz': 'g',
                'st': 'st',
                'pcs': 'st',
                'dozen': 'dozen',
                'boxes': 'dozen',
                'flessen': 'flessen',
                'bottles': 'flessen',
                'rollen': 'rollen',
                'rolls': 'rollen'
            };
            return labels[unit] || unit;
        }

        function updateMaterialStats() {
            const totalValue = materials.reduce((sum, m) => sum + (parseFloat(m.quantity) * parseFloat(m.cost)), 0);
            const lowStock = materials.filter(m => m.reorderLevel && parseFloat(m.quantity) <= parseFloat(m.reorderLevel)).length;
            const totalItems = materials.length;

            document.getElementById('stat-inventory-value').textContent = formatCurrency(totalValue);
            document.getElementById('stat-low-stock').textContent = lowStock;
            document.getElementById('stat-total-materials').textContent = totalItems;
        }

        function filterMaterials() {
            const searchTerm = document.getElementById('material-search').value.toLowerCase();
            
            const filtered = materials.filter(material => {
                return material.name.toLowerCase().includes(searchTerm) ||
                       material.category.toLowerCase().includes(searchTerm) ||
                       (material.supplier && material.supplier.toLowerCase().includes(searchTerm));
            });

            const tbody = document.getElementById('materials-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Geen materialen gevonden.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(material => {
                const totalValue = (parseFloat(material.quantity) * parseFloat(material.cost)).toFixed(2);
                const isLowStock = material.reorderLevel && parseFloat(material.quantity) <= parseFloat(material.reorderLevel);
                
                return `
                    <tr>
                        <td><strong>${material.name}</strong></td>
                        <td>${getCategoryLabel(material.category)}</td>
                        <td>${material.quantity.toString().replace('.', ',')}</td>
                        <td>${getUnitLabel(material.unit)}</td>
                        <td>${formatCurrency(material.cost)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td>
                            ${isLowStock ? '<span class="badge badge-pending">‚ö†Ô∏è Lage Voorraad</span>' : '<span class="badge badge-completed">‚úì Op Voorraad</span>'}
                        </td>
                        <td>
                            <button class="action-btn" onclick="editMaterial('${material.id}')">Bewerken</button>
                            <button class="action-btn delete-btn" onclick="deleteMaterial('${material.id}')">Verwijderen</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ‚úÖ FIXED: Explicitly clear hidden ID field
        function openMaterialModal(materialId = null) {
            const modal = document.getElementById('material-modal');
            const form = document.getElementById('material-form');
            form.reset();
            
            // ‚úÖ FIX: Always clear the hidden ID field first!
            document.getElementById('material-id').value = '';

            if (materialId) {
                const material = materials.find(m => m.id === materialId);
                if (material) {
                    document.getElementById('material-modal-title').textContent = 'Materiaal Bewerken';
                    document.getElementById('material-id').value = material.id;
                    document.getElementById('material-name').value = material.name;
                    document.getElementById('material-category').value = material.category;
                    document.getElementById('material-unit').value = material.unit;
                    document.getElementById('material-quantity').value = material.quantity;
                    document.getElementById('material-reorder-level').value = material.reorderLevel || '';
                    document.getElementById('material-cost').value = material.cost;
                    document.getElementById('material-supplier').value = material.supplier || '';
                    document.getElementById('material-notes').value = material.notes || '';
                }
            } else {
                document.getElementById('material-modal-title').textContent = 'Nieuw Materiaal';
            }

            modal.classList.add('active');
        }

        function closeMaterialModal() {
            document.getElementById('material-modal').classList.remove('active');
            // ‚úÖ FIX: Clear the hidden ID field when closing
            document.getElementById('material-id').value = '';
        }

        // ‚úÖ FIXED: Added index validation
        function saveMaterial(event) {
            event.preventDefault();

            const materialId = document.getElementById('material-id').value;
            const materialData = {
                id: materialId || generateId(),
                name: document.getElementById('material-name').value,
                category: document.getElementById('material-category').value,
                unit: document.getElementById('material-unit').value,
                quantity: document.getElementById('material-quantity').value,
                reorderLevel: document.getElementById('material-reorder-level').value,
                cost: document.getElementById('material-cost').value,
                supplier: document.getElementById('material-supplier').value,
                notes: document.getElementById('material-notes').value,
                lastUpdated: new Date().toISOString()
            };

            if (materialId) {
                const index = materials.findIndex(m => m.id === materialId);
                // ‚úÖ FIX: Check if index is valid
                if (index !== -1) {
                    materials[index] = materialData;
                } else {
                    // ID was set but not found - treat as new
                    materialData.id = generateId();
                    materials.push(materialData);
                }
            } else {
                materials.push(materialData);
            }

            localStorage.setItem('materials', JSON.stringify(materials));
            closeMaterialModal();
            renderMaterials();
        }

        function editMaterial(materialId) {
            openMaterialModal(materialId);
        }

        function deleteMaterial(materialId) {
            if (confirm('Weet u zeker dat u dit materiaal wilt verwijderen?')) {
                materials = materials.filter(m => m.id !== materialId);
                localStorage.setItem('materials', JSON.stringify(materials));
                renderMaterials();
            }
        }

        // Analyse functies
        let revenueChart, statusChart, ordersChart;

        function renderCharts() {
            renderRevenueChart();
            renderStatusChart();
            renderOrdersChart();
        }

        function renderRevenueChart() {
            const ctx = document.getElementById('revenue-chart');
            
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            const months = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            
            const currentYearData = new Array(12).fill(0);
            const lastYearData = new Array(12).fill(0);
            
            orders.forEach(order => {
                const orderDate = new Date(order.orderDate);
                const year = orderDate.getFullYear();
                const month = orderDate.getMonth();
                
                if (year === currentYear) {
                    currentYearData[month] += parseFloat(order.price);
                } else if (year === lastYear) {
                    lastYearData[month] += parseFloat(order.price);
                }
            });

            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: currentYear,
                            data: currentYearData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: lastYear,
                            data: lastYearData,
                            borderColor: '#ccc',
                            backgroundColor: 'rgba(200, 200, 200, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString('nl-NL');
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderStatusChart() {
            const ctx = document.getElementById('status-chart');
            
            const statusCounts = {
                pending: 0,
                'in-progress': 0,
                completed: 0
            };
            
            orders.forEach(order => {
                statusCounts[order.status]++;
            });

            if (statusChart) {
                statusChart.destroy();
            }

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['In afwachting', 'In bewerking', 'Voltooid'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts['in-progress'], statusCounts.completed],
                        backgroundColor: ['#ffc107', '#0d6efd', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderOrdersChart() {
            const ctx = document.getElementById('orders-chart');
            
            const currentYear = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            const monthlyOrders = new Array(12).fill(0);
            
            orders.forEach(order => {
                const orderDate = new Date(order.orderDate);
                if (orderDate.getFullYear() === currentYear) {
                    monthlyOrders[orderDate.getMonth()]++;
                }
            });

            if (ordersChart) {
                ordersChart.destroy();
            }

            ordersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Bestellingen',
                        data: monthlyOrders,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Instellingen functies
        function loadOrderTemplate() {
            if (settings.orderTemplate) {
                document.getElementById('order-template').value = settings.orderTemplate;
            }
        }

        function saveTemplate() {
            settings.orderTemplate = document.getElementById('order-template').value;
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('Sjabloon opgeslagen!');
        }

        function copyTemplate() {
            const template = document.getElementById('order-template');
            template.select();
            document.execCommand('copy');
            alert('Sjabloon gekopieerd naar klembord!');
        }

        function exportData() {
            const data = {
                orders: orders,
                customers: customers,
                materials: materials,
                settings: settings,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sculptuur-bedrijf-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function exportCSV() {
            let csv = 'Bestelnummer,Klantnaam,Omschrijving,Status,Besteldatum,Prijs,Materiaalkosten,Winst\n';
            
            orders.forEach(order => {
                const customer = customers.find(c => c.id === order.customerId);
                const profit = parseFloat(order.price) - parseFloat(order.materialCost || 0);
                csv += `"${order.id}","${customer ? customer.name : 'Onbekend'}","${order.description}","${getStatusLabel(order.status)}","${formatDate(order.orderDate)}","${order.price}","${order.materialCost || 0}","${profit.toFixed(2)}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bestellingen-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecteer eerst een bestand');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Dit vervangt alle huidige gegevens. Weet u het zeker?')) {
                        orders = data.orders || [];
                        customers = data.customers || [];
                        materials = data.materials || [];
                        settings = data.settings || settings;
                        
                        localStorage.setItem('orders', JSON.stringify(orders));
                        localStorage.setItem('customers', JSON.stringify(customers));
                        localStorage.setItem('materials', JSON.stringify(materials));
                        localStorage.setItem('settings', JSON.stringify(settings));
                        
                        location.reload();
                    }
                } catch (error) {
                    alert('Fout bij het lezen van bestand. Controleer of het een geldig backupbestand is.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            const confirmation = prompt('Dit verwijdert ALLES. Typ "VERWIJDEREN" om te bevestigen:');
            
            if (confirmation === 'VERWIJDEREN') {
                localStorage.clear();
                location.reload();
            }
        }

        // Hulpfuncties
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N.v.t.';
            const date = new Date(dateString);
            return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('order-date').value = today;
        }

        // ‚úÖ FIXED: Also clear hidden fields when clicking outside modals
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                // Clear all hidden ID fields when closing any modal by clicking outside
                document.getElementById('order-id').value = '';
                document.getElementById('customer-id').value = '';
                document.getElementById('material-id').value = '';
            }
        }
    </script>
</body>
</html>
</body>
</html>
