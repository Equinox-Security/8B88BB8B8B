<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Grocery%20List%22%2C%22short_name%22%3A%22Groceries%22%2C%22description%22%3A%22Smart%20grocery%20shopping%20list%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f0f4f0%22%2C%22theme_color%22%3A%22%232d6a4f%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520100%2520100%27%253E%253Crect%2520fill%3D%27%25232d6a4f%27%2520width%3D%27100%27%2520height%3D%27100%27%2520rx%3D%2720%27%2F%253E%253Cpath%2520fill%3D%27white%27%2520d%3D%27M25%252028a3%25203%25200%25200%25201%25203-3h4a3%25203%25200%25200%25201%25202.9%25202.2L37%252032h38a3%25203%25200%25200%25201%25202.9%25203.8l-6%252024A3%25203%25200%25200%25201%252069%252062H41a3%25203%25200%25200%25201-2.9-2.2L28.2%252031H28a3%25203%25200%25200%25201-3-3zm17%252044a5%25205%25200%25201%25201%25200%252010%25205%25205%25200%25200%25201%25200-10zm24%25200a5%25205%25200%25201%25201%25200%252010%25205%25205%25200%25200%25201%25200-10z%27%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22any%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
  <meta name="theme-color" content="#2d6a4f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Groceries">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232d6a4f' width='100' height='100' rx='20'/><path fill='white' d='M25 28a3 3 0 0 1 3-3h4a3 3 0 0 1 2.9 2.2L37 32h38a3 3 0 0 1 2.9 3.8l-6 24A3 3 0 0 1 69 62H41a3 3 0 0 1-2.9-2.2L28.2 31H28a3 3 0 0 1-3-3zm17 44a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm24 0a5 5 0 1 1 0 10 5 5 0 0 1 0-10z'/></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Grocery List</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f0f4f0;
      min-height: 100vh;
      color: #1a1a1a;
      padding-bottom: 100px;
    }

    .header {
      background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
      color: white;
      padding: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .header h1 {
      font-size: 1.35rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .header-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .store-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .store-selector {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
    }

    .store-selector label {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .store-selector select {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      background: white;
      color: #2d6a4f;
      cursor: pointer;
    }

    .rewards-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .rewards-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .rewards-btn .badge {
      background: rgba(255,255,255,0.3);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }

    .rewards-panel {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease;
    }

    .rewards-panel.open {
      max-height: 800px;
    }

    .rewards-panel-content {
      padding: 14px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .rewards-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .rewards-panel-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .rewards-panel-close {
      background: none;
      border: none;
      color: white;
      opacity: 0.7;
      font-size: 1.4rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .ebt-balance-display {
      background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ebt-balance-display .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .ebt-balance-display .amount {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .account-card {
      background: white;
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .account-card:last-child {
      margin-bottom: 0;
    }

    .account-header {
      padding: 14px 16px;
      background: #f8f8f8;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .account-info {
      color: #333;
    }

    .account-label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .account-phone {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 1.1rem;
      color: #2d6a4f;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .account-copy-btn {
      background: #e8f5e9;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #2d6a4f;
      font-weight: 500;
    }

    .account-copy-btn:hover {
      background: #c8e6c9;
    }

    .coupons-list {
      padding: 12px 16px;
    }

    .coupon-item {
      display: flex;
      align-items: flex-start;
      padding: 10px 12px;
      background: #f8fdf8;
      border-radius: 8px;
      margin-bottom: 8px;
      gap: 10px;
    }

    .coupon-item:last-child {
      margin-bottom: 0;
    }

    .coupon-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .coupon-badge.free {
      background: #10b981;
      color: white;
    }

    .coupon-badge.discount {
      background: #f59e0b;
      color: white;
    }

    .coupon-badge.threshold {
      background: #6366f1;
      color: white;
    }

    .coupon-details {
      flex: 1;
      min-width: 0;
    }

    .coupon-item-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }

    .coupon-item-value {
      font-size: 0.85rem;
      color: #666;
    }

    .coupon-item-expires {
      font-size: 0.75rem;
      color: #999;
      margin-top: 2px;
    }

    .no-coupons {
      padding: 16px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }

    .mode-toggle {
      display: flex;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 4px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.8);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .mode-btn.active {
      background: white;
      color: #2d6a4f;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .add-form {
      background: white;
      padding: 16px;
      margin: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .form-row {
      display: flex;
      gap: 8px;
    }

    .form-row .input-wrapper {
      flex: 1;
      min-width: 0;
      position: relative;
    }

    .form-row input, .form-row select {
      width: 100%;
    }

    .add-form input, .add-form select {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 10px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: white;
    }

    .add-form input:focus, .add-form select:focus {
      outline: none;
      border-color: #40916c;
      box-shadow: 0 0 0 3px rgba(64,145,108,0.1);
    }

    .add-form input::placeholder {
      color: #999;
    }

    .clear-field-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(calc(-50% - 5px));
      background: #ddd;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      color: #666;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .clear-field-btn.visible {
      display: flex;
    }

    .clear-field-btn:hover {
      background: #ccc;
    }

    .add-form button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }

    .add-form button[type="submit"]:active {
      transform: scale(0.98);
    }

    .quick-dept {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      padding-top: 4px;
    }

    .quick-dept-btn {
      padding: 6px 12px;
      background: #f0f4f0;
      border: 1px solid #ddd;
      border-radius: 16px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
      color: #555;
    }

    .quick-dept-btn:hover {
      background: #e8f5e9;
      border-color: #40916c;
      color: #2d6a4f;
    }

    .quick-dept-btn.active {
      background: #40916c;
      border-color: #40916c;
      color: white;
    }

    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      margin: 0 16px 8px;
      background: #e8f5e9;
      border-radius: 10px;
      font-size: 0.9rem;
      color: #2d6a4f;
    }

    .stats-bar .count {
      font-weight: 600;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .clear-btn:hover {
      background: rgba(0,0,0,0.05);
    }

    .legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      padding: 8px 16px;
      margin: 0 16px 8px;
      font-size: 0.8rem;
      color: #666;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }

    .legend-icon.check {
      background: #40916c;
      color: white;
    }

    .legend-icon.maybe {
      background: #f59e0b;
      color: white;
    }

    .department-group {
      margin: 0 16px 16px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .department-header {
      background: linear-gradient(135deg, #40916c 0%, #52b788 100%);
      color: white;
      padding: 14px 18px;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .aisle-section {
      background: white;
    }

    .aisle-header {
      padding: 10px 18px;
      background: #f8fdf8;
      font-size: 0.82rem;
      color: #666;
      font-weight: 500;
      border-bottom: 1px solid #eef5ee;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .item {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, opacity 0.3s, transform 0.3s;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item.checked-off {
      opacity: 0;
      transform: translateX(50px);
    }

    .item-checkbox {
      width: 28px;
      height: 28px;
      border: 2px solid #ccc;
      border-radius: 50%;
      margin-right: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      font-size: 14px;
      font-weight: bold;
    }

    .item-checkbox.checked {
      background: #40916c;
      border-color: #40916c;
      color: white;
    }

    .item-checkbox.maybe {
      background: #f59e0b;
      border-color: #f59e0b;
      color: white;
    }

    .item-content {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }

    .item-name {
      font-size: 1rem;
      font-weight: 500;
      word-break: break-word;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    .item.is-done .item-name {
      color: #888;
      text-decoration: line-through;
    }

    .item-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .item-tag.free {
      background: #10b981;
      color: white;
    }

    .item-tag.coupon {
      background: #f59e0b;
      color: white;
    }

    .item-meta {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
    }

    .item-account {
      font-size: 0.75rem;
      color: #6366f1;
      margin-top: 2px;
      font-weight: 500;
    }

    .item-delete {
      background: none;
      border: none;
      color: #ccc;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      margin: -8px;
      margin-left: 8px;
      border-radius: 50%;
      transition: color 0.2s, background 0.2s;
    }

    .item-delete:hover {
      color: #e74c3c;
      background: rgba(231,76,60,0.1);
    }

    .empty-state {
      text-align: center;
      padding: 60px 30px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.1rem;
      line-height: 1.5;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      display: flex;
      gap: 10px;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .footer-btn {
      flex: 1;
      padding: 14px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .footer-btn:hover {
      border-color: #40916c;
      color: #40916c;
    }

    .footer-btn:active {
      background: #f8fdf8;
    }

    #file-input {
      display: none;
    }

    /* Modal Base Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      transform: scale(0.9);
      transition: transform 0.2s;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal h3 {
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #2d6a4f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal input[type="text"],
    .modal input[type="tel"],
    .modal input[type="number"],
    .modal input[type="date"],
    .modal select {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 12px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      font-size: 1rem;
      background: white;
    }

    .modal input:focus,
    .modal select:focus {
      outline: none;
      border-color: #40916c;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #666;
    }

    .btn-save {
      background: #40916c;
      color: white;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
    }

    /* Status Toggle in Edit Modal */
    .status-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .status-option {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .status-option:hover {
      border-color: #ccc;
    }

    .status-option.active-none {
      border-color: #666;
      background: #f5f5f5;
    }

    .status-option.active-checked {
      border-color: #40916c;
      background: #e8f5e9;
    }

    .status-option.active-maybe {
      border-color: #f59e0b;
      background: #fef3c7;
    }

    .status-option-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .status-option-label {
      font-size: 0.8rem;
      color: #666;
    }

    /* Settings Modal */
    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .settings-tab {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: #f0f0f0;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-tab.active {
      background: #40916c;
      color: white;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section:last-of-type {
      margin-bottom: 0;
    }

    .settings-section h4 {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .store-list {
      margin-bottom: 12px;
    }

    .store-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      background: #f8f8f8;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 2px solid transparent;
    }

    .store-item.active {
      background: #e8f5e9;
      border-color: #40916c;
    }

    .store-item-name {
      flex: 1;
      font-weight: 500;
    }

    .store-item-actions {
      display: flex;
      gap: 4px;
    }

    .store-item-btn {
      background: none;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .store-item-btn:hover {
      background: rgba(0,0,0,0.1);
    }

    .store-item-btn.delete:hover {
      background: rgba(231,76,60,0.2);
    }

    .add-row {
      display: flex;
      gap: 8px;
    }

    .add-row input {
      flex: 1;
      margin-bottom: 0;
    }

    .add-row button {
      padding: 14px 20px;
      background: #40916c;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    /* Account/Rewards Section */
    .account-section {
      background: #f8f8f8;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .account-section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .account-section-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .account-section-phone {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.9rem;
      color: #2d6a4f;
      margin-top: 4px;
    }

    .account-section-actions {
      display: flex;
      gap: 4px;
    }

    .account-section-btn {
      background: #e0e0e0;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .account-section-btn:hover {
      background: #d0d0d0;
    }

    .account-section-btn.delete:hover {
      background: #fee;
      color: #e74c3c;
    }

    .ebt-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .ebt-input-row label {
      font-size: 0.9rem;
      color: #666;
      white-space: nowrap;
    }

    .ebt-input-row input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      margin: 0;
    }

    .ebt-input-row button {
      padding: 10px 14px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .coupon-list {
      margin-bottom: 12px;
    }

    .coupon-entry {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 6px;
      gap: 8px;
    }

    .coupon-entry-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .coupon-entry-badge.free {
      background: #10b981;
      color: white;
    }

    .coupon-entry-badge.discount {
      background: #f59e0b;
      color: white;
    }

    .coupon-entry-badge.threshold {
      background: #6366f1;
      color: white;
    }

    .coupon-entry-info {
      flex: 1;
      min-width: 0;
    }

    .coupon-entry-name {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .coupon-entry-detail {
      font-size: 0.8rem;
      color: #666;
    }

    .coupon-entry-delete {
      background: none;
      border: none;
      color: #ccc;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .coupon-entry-delete:hover {
      color: #e74c3c;
    }

    .add-coupon-form {
      background: white;
      padding: 12px;
      border-radius: 8px;
    }

    .add-coupon-form .form-group {
      margin-bottom: 10px;
    }

    .add-coupon-form .form-group:last-of-type {
      margin-bottom: 0;
    }

    .add-coupon-form label {
      display: block;
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 4px;
    }

    .add-coupon-form input,
    .add-coupon-form select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      margin: 0;
    }

    .add-coupon-form .form-row {
      display: flex;
      gap: 8px;
    }

    .add-coupon-form .form-row > * {
      flex: 1;
    }

    .add-coupon-form button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #40916c;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .add-account-form {
      background: white;
      padding: 14px;
      border-radius: 10px;
    }

    .add-account-form input {
      margin-bottom: 8px;
    }

    .add-account-form button {
      width: 100%;
      padding: 12px;
      background: #40916c;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .shopping-tip {
      text-align: center;
      padding: 16px;
      margin: 16px;
      background: #fff3cd;
      border-radius: 10px;
      font-size: 0.9rem;
      color: #856404;
    }

    .tap-hint {
      font-size: 0.75rem;
      color: #888;
      text-align: center;
      margin-top: 8px;
    }

    .info-note {
      background: #e3f2fd;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #1565c0;
      margin-top: 16px;
      line-height: 1.4;
    }

    .copied-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 300;
      pointer-events: none;
    }

    .copied-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .item-account-select {
      padding: 8px 12px;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    @media (max-width: 400px) {
      .mode-btn {
        padding: 10px 14px;
        font-size: 0.85rem;
      }

      .footer-btn {
        padding: 12px 8px;
        font-size: 0.8rem;
      }

      .quick-dept-btn {
        padding: 5px 10px;
        font-size: 0.75rem;
      }

      .store-row {
        flex-direction: column;
        gap: 8px;
      }

      .rewards-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <h1>üõí Grocery List</h1>
    <div class="header-actions">
      <button class="header-btn" id="btn-settings" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
  
  <div class="store-row">
    <div class="store-selector">
      <label>üìç</label>
      <select id="store-select"></select>
    </div>
    <button class="rewards-btn" id="btn-rewards" style="display: none;">
      <span>üí≥</span>
      <span>Rewards</span>
      <span class="badge" id="rewards-count"></span>
    </button>
  </div>

  <div class="rewards-panel" id="rewards-panel">
    <div class="rewards-panel-content">
      <div class="rewards-panel-header">
        <span class="rewards-panel-title">üí≥ Rewards & Coupons</span>
        <button class="rewards-panel-close" id="rewards-panel-close">√ó</button>
      </div>
      <div id="ebt-display"></div>
      <div id="rewards-display"></div>
    </div>
  </div>
  
  <div class="mode-toggle">
    <button class="mode-btn active" id="btn-planning">
      <span>üìù</span> Planning
    </button>
    <button class="mode-btn" id="btn-shopping">
      <span>üõçÔ∏è</span> Shopping
    </button>
  </div>
</header>

<main id="main-content">
  <form class="add-form" id="add-form">
    <input type="text" id="input-name" placeholder="Item name..." autocomplete="off" required>
    
    <div class="quick-dept" id="quick-dept"></div>
    
    <div class="form-row">
      <div class="input-wrapper">
        <input type="text" id="input-department" placeholder="Department" list="list-departments" autocomplete="off">
        <button type="button" class="clear-field-btn" id="clear-dept" title="Clear">√ó</button>
      </div>
      <div class="input-wrapper">
        <input type="text" id="input-aisle" placeholder="Aisle/Area" list="list-aisles" autocomplete="off">
        <button type="button" class="clear-field-btn" id="clear-aisle" title="Clear">√ó</button>
      </div>
    </div>
    
    <select id="input-account" class="item-account-select">
      <option value="">No rewards account</option>
    </select>
    
    <select id="input-coupon-type" class="item-account-select">
      <option value="">No coupon</option>
      <option value="free">üÜì FREE item</option>
      <option value="coupon">üè∑Ô∏è Has coupon</option>
    </select>
    
    <button type="submit">+ Add Item</button>
    <p class="tap-hint">Tap item circle to cycle: none ‚Üí ‚úì buy ‚Üí ? maybe</p>
    <datalist id="list-departments"></datalist>
    <datalist id="list-aisles"></datalist>
  </form>

  <div class="stats-bar" id="stats-bar" style="display: none;">
    <span class="count" id="stats-text"></span>
    <button class="clear-btn" id="btn-clear">Clear All ‚úï</button>
  </div>

  <div class="legend" id="legend" style="display: none;">
    <div class="legend-item">
      <div class="legend-icon check">‚úì</div>
      <span>Buy</span>
    </div>
    <div class="legend-item">
      <div class="legend-icon maybe">?</div>
      <span>Maybe</span>
    </div>
  </div>

  <div id="list-container"></div>
</main>

<footer class="footer">
  <button class="footer-btn" id="btn-export">
    <span>üì§</span> Export
  </button>
  <button class="footer-btn" id="btn-import">
    <span>üì•</span> Import
  </button>
</footer>

<input type="file" id="file-input" accept=".json,application/json">

<div class="copied-toast" id="copied-toast">üìã Copied!</div>

<!-- Edit Item Modal -->
<div class="modal" id="edit-modal">
  <div class="modal-content">
    <h3>‚úèÔ∏è Edit Item</h3>
    <input type="text" id="edit-name" placeholder="Item name">
    <input type="text" id="edit-department" placeholder="Department" list="list-departments">
    <input type="text" id="edit-aisle" placeholder="Aisle/Area" list="list-aisles">
    
    <select id="edit-account" class="item-account-select" style="width: 100%; margin-bottom: 12px;"></select>
    
    <select id="edit-coupon-type" class="item-account-select" style="width: 100%; margin-bottom: 12px;">
      <option value="">No coupon</option>
      <option value="free">üÜì FREE item</option>
      <option value="coupon">üè∑Ô∏è Has coupon</option>
    </select>
    
    <div class="status-toggle" id="status-toggle">
      <div class="status-option" data-status="none">
        <div class="status-option-icon">‚óã</div>
        <div class="status-option-label">None</div>
      </div>
      <div class="status-option" data-status="checked">
        <div class="status-option-icon">‚úì</div>
        <div class="status-option-label">Buy</div>
      </div>
      <div class="status-option" data-status="maybe">
        <div class="status-option-icon">?</div>
        <div class="status-option-label">Maybe</div>
      </div>
    </div>
    
    <div class="modal-buttons">
      <button type="button" class="btn-delete" id="btn-edit-delete">Delete</button>
      <button type="button" class="btn-cancel" id="btn-edit-cancel">Cancel</button>
      <button type="button" class="btn-save" id="btn-edit-save">Save</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settings-modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Settings</h3>
    
    <div class="settings-tabs">
      <button class="settings-tab active" data-tab="stores">Stores</button>
      <button class="settings-tab" data-tab="accounts">Accounts</button>
    </div>
    
    <!-- Stores Tab -->
    <div id="tab-stores">
      <div class="settings-section">
        <h4>Your Stores</h4>
        <div class="store-list" id="store-list"></div>
        <div class="add-row">
          <input type="text" id="new-store-name" placeholder="New store name...">
          <button type="button" id="btn-add-store">Add</button>
        </div>
      </div>
    </div>
    
    <!-- Accounts Tab -->
    <div id="tab-accounts" style="display: none;">
      <div class="settings-section">
        <h4>Rewards Accounts for <span id="current-store-name"></span></h4>
        <div id="accounts-list"></div>
        <div class="add-account-form">
          <input type="tel" id="new-account-phone" placeholder="Phone number">
          <input type="text" id="new-account-label" placeholder="Label (e.g., Mom, Work)">
          <button type="button" id="btn-add-account">+ Add Account</button>
        </div>
      </div>
    </div>
    
    <div class="info-note">
      üí° Import only affects one store. Your other stores remain untouched.
    </div>
    
    <div class="modal-buttons">
      <button type="button" class="btn-save" id="btn-settings-close" style="flex: 1;">Done</button>
    </div>
  </div>
</div>

<!-- Rename Store Modal -->
<div class="modal" id="rename-modal">
  <div class="modal-content">
    <h3>‚úèÔ∏è Rename Store</h3>
    <input type="text" id="rename-store-input" placeholder="Store name">
    <div class="modal-buttons">
      <button type="button" class="btn-cancel" id="btn-rename-cancel">Cancel</button>
      <button type="button" class="btn-save" id="btn-rename-save">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'grocery_app_v4';
  const DEFAULT_DEPARTMENTS = [
    'Produce', 'Dairy', 'Meat', 'Seafood', 'Bakery', 'Deli',
    'Frozen', 'Canned Goods', 'Pasta & Grains', 'Condiments',
    'Snacks', 'Beverages', 'Breakfast', 'Household', 'Personal Care', 'Other'
  ];

  let state = {
    stores: ['My Store'],
    currentStore: 'My Store',
    storeData: {
      'My Store': { 
        items: [], 
        accounts: [],
        ebtBalance: null
      }
    },
    mode: 'planning'
  };

  let editingItemId = null;
  let editingStatus = 'none';
  let renamingStore = null;
  let currentSettingsTab = 'stores';

  function getEl(id) {
    return document.getElementById(id);
  }

  const DOM = {
    btnPlanning: getEl('btn-planning'),
    btnShopping: getEl('btn-shopping'),
    btnSettings: getEl('btn-settings'),
    btnRewards: getEl('btn-rewards'),
    rewardsCount: getEl('rewards-count'),
    rewardsPanel: getEl('rewards-panel'),
    rewardsPanelClose: getEl('rewards-panel-close'),
    ebtDisplay: getEl('ebt-display'),
    rewardsDisplay: getEl('rewards-display'),
    storeSelect: getEl('store-select'),
    addForm: getEl('add-form'),
    inputName: getEl('input-name'),
    inputDepartment: getEl('input-department'),
    inputAisle: getEl('input-aisle'),
    inputAccount: getEl('input-account'),
    inputCouponType: getEl('input-coupon-type'),
    clearDept: getEl('clear-dept'),
    clearAisle: getEl('clear-aisle'),
    quickDept: getEl('quick-dept'),
    listDepartments: getEl('list-departments'),
    listAisles: getEl('list-aisles'),
    statsBar: getEl('stats-bar'),
    statsText: getEl('stats-text'),
    btnClear: getEl('btn-clear'),
    legend: getEl('legend'),
    listContainer: getEl('list-container'),
    btnExport: getEl('btn-export'),
    btnImport: getEl('btn-import'),
    fileInput: getEl('file-input'),
    copiedToast: getEl('copied-toast'),
    editModal: getEl('edit-modal'),
    editName: getEl('edit-name'),
    editDepartment: getEl('edit-department'),
    editAisle: getEl('edit-aisle'),
    editAccount: getEl('edit-account'),
    editCouponType: getEl('edit-coupon-type'),
    statusToggle: getEl('status-toggle'),
    btnEditDelete: getEl('btn-edit-delete'),
    btnEditCancel: getEl('btn-edit-cancel'),
    btnEditSave: getEl('btn-edit-save'),
    settingsModal: getEl('settings-modal'),
    tabStores: getEl('tab-stores'),
    tabAccounts: getEl('tab-accounts'),
    currentStoreName: getEl('current-store-name'),
    storeList: getEl('store-list'),
    newStoreName: getEl('new-store-name'),
    btnAddStore: getEl('btn-add-store'),
    accountsList: getEl('accounts-list'),
    newAccountPhone: getEl('new-account-phone'),
    newAccountLabel: getEl('new-account-label'),
    btnAddAccount: getEl('btn-add-account'),
    btnSettingsClose: getEl('btn-settings-close'),
    renameModal: getEl('rename-modal'),
    renameStoreInput: getEl('rename-store-input'),
    btnRenameCancel: getEl('btn-rename-cancel'),
    btnRenameSave: getEl('btn-rename-save')
  };

  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  function sanitizeFilename(name) {
    return name.replace(/[^a-z0-9]/gi, '_').replace(/_+/g, '_');
  }

  function formatPhoneNumber(phone) {
    const digits = phone.replace(/\D/g, '');
    if (digits.length === 10) {
      return '(' + digits.slice(0,3) + ') ' + digits.slice(3,6) + '-' + digits.slice(6);
    } else if (digits.length === 11 && digits[0] === '1') {
      return '+1 (' + digits.slice(1,4) + ') ' + digits.slice(4,7) + '-' + digits.slice(7);
    }
    return phone;
  }

  function getCurrentStoreData() {
    if (!state.storeData[state.currentStore]) {
      state.storeData[state.currentStore] = { items: [], accounts: [], ebtBalance: null };
    }
    const data = state.storeData[state.currentStore];
    if (!data.accounts) data.accounts = [];
    if (!data.items) data.items = [];
    return data;
  }

  function getCurrentItems() {
    return getCurrentStoreData().items;
  }

  function getCurrentAccounts() {
    return getCurrentStoreData().accounts;
  }

  function getAccountById(accountId) {
    return getCurrentAccounts().find(a => a.id === accountId);
  }

  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function load() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        if (parsed.stores && parsed.storeData) {
          state = parsed;
          // Ensure structure
          for (const store in state.storeData) {
            if (!state.storeData[store].accounts) {
              // Migrate old rewards to accounts
              if (state.storeData[store].rewards) {
                state.storeData[store].accounts = state.storeData[store].rewards.map(r => ({
                  id: generateId(),
                  phone: r.phone,
                  label: r.label || '',
                  coupons: [],
                  ebtBalance: null
                }));
                delete state.storeData[store].rewards;
              } else {
                state.storeData[store].accounts = [];
              }
            }
            if (!state.storeData[store].items) state.storeData[store].items = [];
          }
          if (!state.stores.includes(state.currentStore)) {
            state.currentStore = state.stores[0] || 'My Store';
          }
          return;
        }
      }

      // Try older versions
      for (const key of ['grocery_app_v3', 'grocery_app_v2', 'grocery_app_v1']) {
        const oldData = localStorage.getItem(key);
        if (oldData) {
          const parsed = JSON.parse(oldData);
          if (parsed.stores && parsed.storeData) {
            state.stores = parsed.stores;
            state.currentStore = parsed.currentStore || parsed.stores[0];
            state.mode = parsed.mode || 'planning';
            state.storeData = {};
            for (const store of parsed.stores) {
              const sd = parsed.storeData[store] || {};
              state.storeData[store] = {
                items: (sd.items || []).map(item => ({
                  ...item,
                  status: item.status || (item.checked ? 'checked' : 'none'),
                  accountId: null,
                  couponType: ''
                })),
                accounts: (sd.rewards || []).map(r => ({
                  id: generateId(),
                  phone: r.phone,
                  label: r.label || '',
                  coupons: [],
                  ebtBalance: null
                })),
                ebtBalance: null
              };
            }
            save();
            return;
          } else if (Array.isArray(parsed.items)) {
            state = {
              stores: ['My Store'],
              currentStore: 'My Store',
              storeData: {
                'My Store': {
                  items: parsed.items.map(item => ({
                    ...item,
                    status: item.checked ? 'checked' : 'none',
                    accountId: null,
                    couponType: ''
                  })),
                  accounts: [],
                  ebtBalance: null
                }
              },
              mode: 'planning'
            };
            save();
            return;
          }
        }
      }
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  function getUniqueDepartments() {
    const items = getCurrentItems();
    const used = items.map(i => i.department).filter(Boolean);
    const all = [...new Set([...DEFAULT_DEPARTMENTS, ...used])];
    return all.sort((a, b) => a.localeCompare(b));
  }

  function getUniqueAisles() {
    const items = getCurrentItems();
    const aisles = items.map(i => i.aisle).filter(Boolean);
    return [...new Set(aisles)].sort((a, b) => a.localeCompare(b));
  }

  function getFrequentDepartments() {
    const items = getCurrentItems();
    const counts = {};
    items.forEach(item => {
      if (item.department) {
        counts[item.department] = (counts[item.department] || 0) + 1;
      }
    });

    const sorted = Object.entries(counts)
      .sort((a, b) => b[1] - a[1])
      .map(e => e[0])
      .slice(0, 6);

    const defaults = ['Produce', 'Dairy', 'Meat', 'Frozen', 'Bakery', 'Deli'];
    for (const d of defaults) {
      if (!sorted.includes(d) && sorted.length < 6) sorted.push(d);
    }

    return sorted;
  }

  function showCopiedToast() {
    DOM.copiedToast.classList.add('show');
    setTimeout(() => DOM.copiedToast.classList.remove('show'), 2000);
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(showCopiedToast).catch(() => {});
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try { document.execCommand('copy'); showCopiedToast(); } catch (e) {}
      document.body.removeChild(textarea);
    }
  }

  // === Rendering ===
  function updateStoreSelect() {
    DOM.storeSelect.innerHTML = state.stores.map(store => {
      const selected = store === state.currentStore ? ' selected' : '';
      return '<option value="' + escapeHtml(store) + '"' + selected + '>' + escapeHtml(store) + '</option>';
    }).join('');
  }

  function updateAccountSelects() {
    const accounts = getCurrentAccounts();
    const options = '<option value="">No rewards account</option>' + 
      accounts.map(a => {
        const label = a.label ? a.label + ' - ' + formatPhoneNumber(a.phone) : formatPhoneNumber(a.phone);
        return '<option value="' + a.id + '">' + escapeHtml(label) + '</option>';
      }).join('');
    
    DOM.inputAccount.innerHTML = options;
    DOM.editAccount.innerHTML = options;
  }

  function updateRewardsButton() {
    const accounts = getCurrentAccounts();
    const storeData = getCurrentStoreData();
    const totalCoupons = accounts.reduce((sum, a) => sum + (a.coupons ? a.coupons.length : 0), 0);
    const hasEbt = storeData.ebtBalance !== null && storeData.ebtBalance !== '';
    
    if (accounts.length > 0 || hasEbt) {
      DOM.btnRewards.style.display = 'flex';
      DOM.rewardsCount.textContent = accounts.length + (totalCoupons > 0 ? '+' + totalCoupons : '');
    } else {
      DOM.btnRewards.style.display = 'none';
      DOM.rewardsPanel.classList.remove('open');
    }
  }

  function updateRewardsPanel() {
    const storeData = getCurrentStoreData();
    const accounts = getCurrentAccounts();

    // EBT Display
    if (storeData.ebtBalance !== null && storeData.ebtBalance !== '') {
      DOM.ebtDisplay.innerHTML = 
        '<div class="ebt-balance-display">' +
        '<span class="label">üí≥ EBT Balance</span>' +
        '<span class="amount">$' + parseFloat(storeData.ebtBalance).toFixed(2) + '</span>' +
        '</div>';
    } else {
      DOM.ebtDisplay.innerHTML = '';
    }

    if (accounts.length === 0) {
      DOM.rewardsDisplay.innerHTML = '<div class="no-coupons">No rewards accounts. Add them in Settings.</div>';
      return;
    }

    let html = '';
    accounts.forEach(account => {
      html += '<div class="account-card">';
      html += '<div class="account-header">';
      html += '<div class="account-info">';
      if (account.label) html += '<div class="account-label">' + escapeHtml(account.label) + '</div>';
      html += '<div class="account-phone">' + escapeHtml(formatPhoneNumber(account.phone)) + '</div>';
      html += '</div>';
      html += '<button class="account-copy-btn" data-phone="' + escapeHtml(account.phone.replace(/\D/g, '')) + '">üìã Copy</button>';
      html += '</div>';

      const coupons = account.coupons || [];
      if (coupons.length > 0) {
        html += '<div class="coupons-list">';
        coupons.forEach(coupon => {
          let badgeClass = coupon.type === 'free' ? 'free' : (coupon.type === 'threshold' ? 'threshold' : 'discount');
          let badgeText = coupon.type === 'free' ? 'FREE' : (coupon.type === 'threshold' ? 'Threshold' : 'Coupon');
          
          html += '<div class="coupon-item">';
          html += '<span class="coupon-badge ' + badgeClass + '">' + badgeText + '</span>';
          html += '<div class="coupon-details">';
          html += '<div class="coupon-item-name">' + escapeHtml(coupon.name || coupon.description) + '</div>';
          if (coupon.value) html += '<div class="coupon-item-value">' + escapeHtml(coupon.value) + '</div>';
          if (coupon.minSpend) html += '<div class="coupon-item-value">Min spend: $' + coupon.minSpend + '</div>';
          if (coupon.expires) html += '<div class="coupon-item-expires">Expires: ' + coupon.expires + '</div>';
          html += '</div></div>';
        });
        html += '</div>';
      } else {
        html += '<div class="no-coupons" style="padding: 12px 16px;">No coupons for this account</div>';
      }

      html += '</div>';
    });

    DOM.rewardsDisplay.innerHTML = html;
  }

  function updateDatalists() {
    DOM.listDepartments.innerHTML = getUniqueDepartments()
      .map(d => '<option value="' + escapeHtml(d) + '">').join('');
    DOM.listAisles.innerHTML = getUniqueAisles()
      .map(a => '<option value="' + escapeHtml(a) + '">').join('');
  }

  function updateQuickDepartments() {
    const frequent = getFrequentDepartments();
    const currentDept = DOM.inputDepartment.value.trim();

    DOM.quickDept.innerHTML = frequent.map(dept => {
      const activeClass = dept === currentDept ? ' active' : '';
      return '<button type="button" class="quick-dept-btn' + activeClass + '" data-dept="' + escapeHtml(dept) + '">' + escapeHtml(dept) + '</button>';
    }).join('');
  }

  function updateClearButtons() {
    DOM.clearDept.classList.toggle('visible', DOM.inputDepartment.value.length > 0);
    DOM.clearAisle.classList.toggle('visible', DOM.inputAisle.value.length > 0);
  }

  function updateModeButtons() {
    DOM.btnPlanning.classList.toggle('active', state.mode === 'planning');
    DOM.btnShopping.classList.toggle('active', state.mode === 'shopping');
    DOM.addForm.style.display = state.mode === 'planning' ? 'block' : 'none';
  }

  function updateStats() {
    const items = getCurrentItems();
    const total = items.length;
    const checked = items.filter(i => i.status === 'checked').length;
    const maybe = items.filter(i => i.status === 'maybe').length;
    const selected = checked + maybe;

    if (total === 0) {
      DOM.statsBar.style.display = 'none';
      DOM.legend.style.display = 'none';
      return;
    }

    DOM.statsBar.style.display = 'flex';
    DOM.legend.style.display = (maybe > 0) ? 'flex' : 'none';

    if (state.mode === 'shopping') {
      let text = checked + ' to buy';
      if (maybe > 0) text += ', ' + maybe + ' to check';
      DOM.statsText.textContent = text;
      DOM.btnClear.textContent = 'Done Shopping';
    } else {
      DOM.statsText.textContent = selected + ' of ' + total + ' selected';
      DOM.btnClear.textContent = 'Clear Selection';
    }
  }

  function groupItems(items) {
    // Group by account first, then by department/aisle
    const byAccount = { '': {} };
    const accounts = getCurrentAccounts();
    
    items.forEach(item => {
      const accountId = item.accountId || '';
      if (!byAccount[accountId]) byAccount[accountId] = {};
      
      const dept = item.department || 'Other';
      const aisle = item.aisle || '';
      
      if (!byAccount[accountId][dept]) byAccount[accountId][dept] = {};
      if (!byAccount[accountId][dept][aisle]) byAccount[accountId][dept][aisle] = [];
      byAccount[accountId][dept][aisle].push(item);
    });
    
    return byAccount;
  }

  function renderList() {
    const allItems = getCurrentItems();
    const isShoppingMode = state.mode === 'shopping';
    const items = isShoppingMode
      ? allItems.filter(i => i.status === 'checked' || i.status === 'maybe')
      : allItems;

    if (items.length === 0) {
      if (isShoppingMode) {
        const hasSelected = allItems.some(i => i.status === 'checked' || i.status === 'maybe');
        if (!hasSelected && allItems.length > 0) {
          DOM.listContainer.innerHTML = 
            '<div class="shopping-tip">üí° Switch to Planning mode and select items!</div>' +
            '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div>' +
            '<div class="empty-state-text">No items selected.</div></div>';
        } else {
          DOM.listContainer.innerHTML = 
            '<div class="empty-state"><div class="empty-state-icon">üéâ</div>' +
            '<div class="empty-state-text">All done!<br>Great shopping!</div></div>';
        }
      } else {
        DOM.listContainer.innerHTML = 
          '<div class="empty-state"><div class="empty-state-icon">üìù</div>' +
          '<div class="empty-state-text">Your list is empty.<br>Add items above!</div></div>';
      }
      return;
    }

    const accounts = getCurrentAccounts();
    const byAccount = groupItems(items);
    let html = '';

    // Sort account IDs: items without account first, then by account
    const accountIds = Object.keys(byAccount).sort((a, b) => {
      if (a === '') return -1;
      if (b === '') return 1;
      return 0;
    });

    accountIds.forEach(accountId => {
      const account = accountId ? getAccountById(accountId) : null;
      const groups = byAccount[accountId];
      
      // Account header if applicable
      if (account && isShoppingMode) {
        html += '<div style="background: #6366f1; color: white; padding: 12px 18px; margin: 0 16px 8px; border-radius: 10px;">';
        html += '<div style="font-weight: 600;">' + escapeHtml(account.label || 'Account') + '</div>';
        html += '<div style="font-family: monospace; font-size: 1.1rem;">' + escapeHtml(formatPhoneNumber(account.phone)) + '</div>';
        html += '</div>';
      }

      const sortedDepts = Object.keys(groups).sort((a, b) => {
        if (a === 'Other') return 1;
        if (b === 'Other') return -1;
        return a.localeCompare(b);
      });

      sortedDepts.forEach(dept => {
        const aisles = groups[dept];
        const sortedAisles = Object.keys(aisles).sort((a, b) => {
          if (a === '') return 1;
          if (b === '') return -1;
          return a.localeCompare(b, undefined, { numeric: true });
        });

        html += '<div class="department-group">';
        html += '<div class="department-header">üè∑Ô∏è ' + escapeHtml(dept) + '</div>';

        sortedAisles.forEach(aisle => {
          const aisleItems = aisles[aisle].sort((a, b) => a.name.localeCompare(b.name));

          html += '<div class="aisle-section">';
          if (aisle) html += '<div class="aisle-header">üìç ' + escapeHtml(aisle) + '</div>';

          aisleItems.forEach(item => {
            const status = item.status || 'none';
            const checkboxClass = status === 'checked' ? 'checked' : (status === 'maybe' ? 'maybe' : '');
            const checkboxContent = status === 'checked' ? '‚úì' : (status === 'maybe' ? '?' : '');
            const itemClass = status !== 'none' && !isShoppingMode ? 'is-done' : '';
            const itemAccount = item.accountId ? getAccountById(item.accountId) : null;

            html += '<div class="item ' + itemClass + '" data-id="' + item.id + '">';
            html += '<div class="item-checkbox ' + checkboxClass + '" data-action="toggle" data-id="' + item.id + '">' + checkboxContent + '</div>';
            html += '<div class="item-content" data-action="edit" data-id="' + item.id + '">';
            
            html += '<div class="item-name">' + escapeHtml(item.name);
            if (item.couponType === 'free') {
              html += ' <span class="item-tag free">FREE</span>';
            } else if (item.couponType === 'coupon') {
              html += ' <span class="item-tag coupon">COUPON</span>';
            }
            html += '</div>';

            if (!isShoppingMode && item.aisle) {
              html += '<div class="item-meta">' + escapeHtml(item.aisle) + '</div>';
            }
            
            if (itemAccount) {
              html += '<div class="item-account">üë§ ' + escapeHtml(itemAccount.label || formatPhoneNumber(itemAccount.phone)) + '</div>';
            }

            html += '</div>';
            html += '<button class="item-delete" data-action="delete" data-id="' + item.id + '">√ó</button>';
            html += '</div>';
          });

          html += '</div>';
        });

        html += '</div>';
      });
    });

    DOM.listContainer.innerHTML = html;
  }

  function renderStoreList() {
    DOM.storeList.innerHTML = state.stores.map(store => {
      const activeClass = store === state.currentStore ? ' active' : '';
      const canDelete = state.stores.length > 1;
      
      let html = '<div class="store-item' + activeClass + '">';
      html += '<span class="store-item-name">' + escapeHtml(store);
      if (store === state.currentStore) html += ' <span style="color:#40916c;font-size:0.8rem">(current)</span>';
      html += '</span><div class="store-item-actions">';
      html += '<button class="store-item-btn" data-action="select-store" data-store="' + escapeHtml(store) + '">Select</button>';
      html += '<button class="store-item-btn" data-action="rename" data-store="' + escapeHtml(store) + '">‚úèÔ∏è</button>';
      if (canDelete) html += '<button class="store-item-btn delete" data-action="delete-store" data-store="' + escapeHtml(store) + '">üóëÔ∏è</button>';
      html += '</div></div>';
      return html;
    }).join('');
  }

  function renderAccountsList() {
    DOM.currentStoreName.textContent = state.currentStore;
    const storeData = getCurrentStoreData();
    const accounts = getCurrentAccounts();

    let html = '';

    // EBT Balance section
    html += '<div class="account-section" style="background: #f3e8ff;">';
    html += '<div class="account-section-header"><span class="account-section-title">üí≥ EBT Balance</span></div>';
    html += '<div class="ebt-input-row">';
    html += '<label>Balance: $</label>';
    html += '<input type="number" step="0.01" min="0" id="ebt-balance-input" value="' + (storeData.ebtBalance || '') + '" placeholder="0.00">';
    html += '<button type="button" id="btn-save-ebt">Save</button>';
    html += '</div></div>';

    // Accounts
    accounts.forEach((account, index) => {
      html += '<div class="account-section">';
      html += '<div class="account-section-header">';
      html += '<div>';
      html += '<div class="account-section-title">üì± ' + escapeHtml(account.label || 'Account ' + (index + 1)) + '</div>';
      html += '<div class="account-section-phone">' + escapeHtml(formatPhoneNumber(account.phone)) + '</div>';
      html += '</div>';
      html += '<div class="account-section-actions">';
      html += '<button class="account-section-btn delete" data-action="delete-account" data-id="' + account.id + '">üóëÔ∏è</button>';
      html += '</div></div>';

      // Coupons list
      const coupons = account.coupons || [];
      if (coupons.length > 0) {
        html += '<div class="coupon-list">';
        coupons.forEach((coupon, ci) => {
          const badgeClass = coupon.type === 'free' ? 'free' : (coupon.type === 'threshold' ? 'threshold' : 'discount');
          const badgeText = coupon.type === 'free' ? 'FREE' : (coupon.type === 'threshold' ? '$$ OFF' : 'COUPON');
          
          html += '<div class="coupon-entry">';
          html += '<span class="coupon-entry-badge ' + badgeClass + '">' + badgeText + '</span>';
          html += '<div class="coupon-entry-info">';
          html += '<div class="coupon-entry-name">' + escapeHtml(coupon.name || coupon.description) + '</div>';
          let detail = '';
          if (coupon.value) detail += coupon.value;
          if (coupon.minSpend) detail += (detail ? ' ‚Ä¢ ' : '') + 'Min $' + coupon.minSpend;
          if (coupon.expires) detail += (detail ? ' ‚Ä¢ ' : '') + 'Exp: ' + coupon.expires;
          if (detail) html += '<div class="coupon-entry-detail">' + escapeHtml(detail) + '</div>';
          html += '</div>';
          html += '<button class="coupon-entry-delete" data-action="delete-coupon" data-account="' + account.id + '" data-index="' + ci + '">√ó</button>';
          html += '</div>';
        });
        html += '</div>';
      }

      // Add coupon form
      html += '<div class="add-coupon-form">';
      html += '<div class="form-group"><label>Coupon Type</label>';
      html += '<select data-coupon-type-for="' + account.id + '">';
      html += '<option value="free">üÜì Free Item</option>';
      html += '<option value="discount">üè∑Ô∏è Personal Coupon</option>';
      html += '<option value="threshold">üí∞ Threshold ($X off $Y+)</option>';
      html += '</select></div>';
      html += '<div class="form-group"><label>Item / Description</label>';
      html += '<input type="text" placeholder="e.g., Deli Turkey 1lb" data-coupon-name-for="' + account.id + '"></div>';
      html += '<div class="form-row">';
      html += '<div class="form-group"><label>Value (optional)</label>';
      html += '<input type="text" placeholder="e.g., $2 off" data-coupon-value-for="' + account.id + '"></div>';
      html += '<div class="form-group"><label>Min Spend</label>';
      html += '<input type="number" placeholder="e.g., 90" data-coupon-min-for="' + account.id + '"></div>';
      html += '</div>';
      html += '<div class="form-group"><label>Expires (optional)</label>';
      html += '<input type="date" data-coupon-expires-for="' + account.id + '"></div>';
      html += '<button type="button" data-action="add-coupon" data-account="' + account.id + '">+ Add Coupon</button>';
      html += '</div></div>';
    });

    DOM.accountsList.innerHTML = html;

    // Attach EBT save handler
    const ebtInput = getEl('ebt-balance-input');
    const btnSaveEbt = getEl('btn-save-ebt');
    if (btnSaveEbt) {
      btnSaveEbt.onclick = function() {
        const val = ebtInput.value.trim();
        getCurrentStoreData().ebtBalance = val ? parseFloat(val) : null;
        save();
        render();
      };
    }
  }

  function render() {
    updateStoreSelect();
    updateAccountSelects();
    updateRewardsButton();
    updateRewardsPanel();
    updateModeButtons();
    updateStats();
    updateDatalists();
    updateQuickDepartments();
    updateClearButtons();
    renderList();
  }

  // === Actions ===
  function setMode(mode) {
    state.mode = mode;
    save();
    render();
  }

  function setCurrentStore(storeName) {
    if (state.stores.includes(storeName)) {
      state.currentStore = storeName;
      DOM.rewardsPanel.classList.remove('open');
      save();
      render();
    }
  }

  function addStore(name) {
    const trimmed = name.trim();
    if (!trimmed) return false;
    if (state.stores.includes(trimmed)) {
      alert('Store already exists.');
      return false;
    }

    state.stores.push(trimmed);
    state.storeData[trimmed] = { items: [], accounts: [], ebtBalance: null };
    state.currentStore = trimmed;
    save();
    render();
    renderStoreList();
    return true;
  }

  function renameStore(oldName, newName) {
    const trimmed = newName.trim();
    if (!trimmed) return false;
    if (trimmed === oldName) return true;
    if (state.stores.includes(trimmed)) {
      alert('Store already exists.');
      return false;
    }

    const index = state.stores.indexOf(oldName);
    if (index === -1) return false;

    state.stores[index] = trimmed;
    state.storeData[trimmed] = state.storeData[oldName];
    delete state.storeData[oldName];

    if (state.currentStore === oldName) state.currentStore = trimmed;

    save();
    render();
    renderStoreList();
    return true;
  }

  function deleteStore(name) {
    if (state.stores.length <= 1) {
      alert('Must have at least one store.');
      return;
    }

    if (!confirm('Delete "' + name + '" and all its data?')) return;

    const index = state.stores.indexOf(name);
    if (index === -1) return;

    state.stores.splice(index, 1);
    delete state.storeData[name];

    if (state.currentStore === name) state.currentStore = state.stores[0];

    save();
    render();
    renderStoreList();
  }

  function addAccount(phone, label) {
    const trimmed = phone.replace(/\D/g, '');
    if (!trimmed) return false;

    const account = {
      id: generateId(),
      phone: trimmed,
      label: label.trim(),
      coupons: []
    };

    getCurrentAccounts().push(account);
    save();
    render();
    renderAccountsList();
    return true;
  }

  function deleteAccount(accountId) {
    const accounts = getCurrentAccounts();
    const index = accounts.findIndex(a => a.id === accountId);
    if (index === -1) return;
    
    if (!confirm('Delete this account and all its coupons?')) return;
    
    accounts.splice(index, 1);
    
    // Clear accountId from items
    getCurrentItems().forEach(item => {
      if (item.accountId === accountId) item.accountId = null;
    });
    
    save();
    render();
    renderAccountsList();
  }

  function addCoupon(accountId, type, name, value, minSpend, expires) {
    const account = getAccountById(accountId);
    if (!account) return false;
    if (!name.trim()) return false;

    if (!account.coupons) account.coupons = [];
    
    account.coupons.push({
      type: type,
      name: name.trim(),
      value: value.trim(),
      minSpend: minSpend ? parseFloat(minSpend) : null,
      expires: expires || null
    });

    save();
    renderAccountsList();
    updateRewardsPanel();
    return true;
  }

  function deleteCoupon(accountId, couponIndex) {
    const account = getAccountById(accountId);
    if (!account || !account.coupons) return;
    
    account.coupons.splice(couponIndex, 1);
    save();
    renderAccountsList();
    updateRewardsPanel();
  }

  function addItem(name, department, aisle, accountId, couponType) {
    const item = {
      id: generateId(),
      name: name.trim(),
      department: department.trim() || 'Other',
      aisle: aisle.trim(),
      status: 'none',
      accountId: accountId || null,
      couponType: couponType || ''
    };

    getCurrentItems().push(item);
    save();
    render();
  }

  function cycleItemStatus(id) {
    const items = getCurrentItems();
    const item = items.find(i => i.id === id);
    if (!item) return;

    const oldStatus = item.status || 'none';
    item.status = oldStatus === 'none' ? 'checked' : (oldStatus === 'checked' ? 'maybe' : 'none');
    save();

    if (state.mode === 'shopping' && item.status === 'none') {
      const itemEl = DOM.listContainer.querySelector('[data-id="' + id + '"].item');
      if (itemEl) {
        itemEl.classList.add('checked-off');
        setTimeout(render, 300);
        return;
      }
    }

    render();
  }

  function deleteItem(id) {
    const items = getCurrentItems();
    const index = items.findIndex(i => i.id === id);
    if (index !== -1) items.splice(index, 1);
    save();
    render();
    closeEditModal();
  }

  function updateItem(id, name, department, aisle, accountId, couponType, status) {
    const item = getCurrentItems().find(i => i.id === id);
    if (!item) return;

    item.name = name.trim() || item.name;
    item.department = department.trim() || 'Other';
    item.aisle = aisle.trim();
    item.accountId = accountId || null;
    item.couponType = couponType || '';
    item.status = status || 'none';

    save();
    render();
  }

  function clearSelection() {
    getCurrentItems().forEach(item => { item.status = 'none'; });
    save();
    render();
  }

  function clearForm() {
    DOM.inputName.value = '';
    DOM.inputDepartment.value = '';
    DOM.inputAisle.value = '';
    DOM.inputAccount.value = '';
    DOM.inputCouponType.value = '';
    updateClearButtons();
    updateQuickDepartments();
  }

  function exportData() {
    const storeData = getCurrentStoreData();
    const exportObj = {
      version: 4,
      exportDate: new Date().toISOString(),
      storeName: state.currentStore,
      items: storeData.items,
      accounts: storeData.accounts,
      ebtBalance: storeData.ebtBalance
    };

    const json = JSON.stringify(exportObj, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    const date = new Date().toISOString().split('T')[0];
    a.download = sanitizeFilename(state.currentStore) + '-' + date + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData(file) {
    const reader = new FileReader();

    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        let items = [], accounts = [], ebtBalance = null;
        let storeName = data.storeName || 'Imported Store';

        if (Array.isArray(data.items)) items = data.items;
        else if (Array.isArray(data)) items = data;

        if (Array.isArray(data.accounts)) accounts = data.accounts;
        else if (Array.isArray(data.rewards)) {
          accounts = data.rewards.map(r => ({
            id: generateId(),
            phone: r.phone,
            label: r.label || '',
            coupons: []
          }));
        }

        if (data.ebtBalance !== undefined) ebtBalance = data.ebtBalance;

        items = items.filter(item => item && item.name).map(item => ({
          id: item.id || generateId(),
          name: String(item.name).trim(),
          department: String(item.department || 'Other').trim(),
          aisle: String(item.aisle || '').trim(),
          status: ['none','checked','maybe'].includes(item.status) ? item.status : (item.checked ? 'checked' : 'none'),
          accountId: item.accountId || null,
          couponType: item.couponType || ''
        }));

        accounts = accounts.filter(a => a && a.phone).map(a => ({
          id: a.id || generateId(),
          phone: String(a.phone).replace(/\D/g, ''),
          label: String(a.label || '').trim(),
          coupons: Array.isArray(a.coupons) ? a.coupons : []
        }));

        if (items.length === 0 && accounts.length === 0) {
          alert('No valid data found.');
          return;
        }

        let targetStore = storeName;
        if (state.stores.includes(storeName)) {
          if (!confirm('Replace data in "' + storeName + '"?\n\nCancel to create new store.')) {
            let c = 2;
            while (state.stores.includes(storeName + ' (' + c + ')')) c++;
            targetStore = storeName + ' (' + c + ')';
          }
        }

        if (!state.stores.includes(targetStore)) state.stores.push(targetStore);
        state.storeData[targetStore] = { items, accounts, ebtBalance };
        state.currentStore = targetStore;
        state.mode = 'planning';
        
        save();
        render();
        
        alert('Imported to "' + targetStore + '":\n‚Ä¢ ' + items.length + ' items\n‚Ä¢ ' + accounts.length + ' accounts');
      } catch (err) {
        alert('Could not read file.');
      }
    };

    reader.onerror = function() { alert('Error reading file.'); };
    reader.readAsText(file);
  }

  // === Edit Modal ===
  function openEditModal(id) {
    const item = getCurrentItems().find(i => i.id === id);
    if (!item) return;

    editingItemId = id;
    editingStatus = item.status || 'none';
    
    DOM.editName.value = item.name;
    DOM.editDepartment.value = item.department;
    DOM.editAisle.value = item.aisle;
    DOM.editAccount.value = item.accountId || '';
    DOM.editCouponType.value = item.couponType || '';
    
    updateStatusToggle();
    
    DOM.editModal.classList.add('active');
    DOM.editName.focus();
  }

  function updateStatusToggle() {
    const options = DOM.statusToggle.querySelectorAll('.status-option');
    options.forEach(opt => {
      opt.className = 'status-option';
      if (opt.dataset.status === editingStatus) {
        opt.classList.add('active-' + editingStatus);
      }
    });
  }

  function closeEditModal() {
    editingItemId = null;
    DOM.editModal.classList.remove('active');
  }

  function saveEdit() {
    if (!editingItemId) return;
    const name = DOM.editName.value.trim();
    if (!name) { DOM.editName.focus(); return; }

    updateItem(
      editingItemId,
      name,
      DOM.editDepartment.value,
      DOM.editAisle.value,
      DOM.editAccount.value,
      DOM.editCouponType.value,
      editingStatus
    );

    closeEditModal();
  }

  // === Settings Modal ===
  function openSettingsModal() {
    renderStoreList();
    renderAccountsList();
    DOM.newStoreName.value = '';
    DOM.settingsModal.classList.add('active');
    switchSettingsTab('stores');
  }

  function closeSettingsModal() {
    DOM.settingsModal.classList.remove('active');
  }

  function switchSettingsTab(tab) {
    currentSettingsTab = tab;
    DOM.tabStores.style.display = tab === 'stores' ? 'block' : 'none';
    DOM.tabAccounts.style.display = tab === 'accounts' ? 'block' : 'none';
    
    document.querySelectorAll('.settings-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === tab);
    });
    
    if (tab === 'accounts') renderAccountsList();
  }

  // === Rename Modal ===
  function openRenameModal(storeName) {
    renamingStore = storeName;
    DOM.renameStoreInput.value = storeName;
    DOM.renameModal.classList.add('active');
    DOM.renameStoreInput.focus();
    DOM.renameStoreInput.select();
  }

  function closeRenameModal() {
    renamingStore = null;
    DOM.renameModal.classList.remove('active');
  }

  function saveRename() {
    if (!renamingStore) return;
    if (renameStore(renamingStore, DOM.renameStoreInput.value)) {
      closeRenameModal();
    }
  }

  // === Event Handlers ===
  DOM.btnPlanning.addEventListener('click', () => setMode('planning'));
  DOM.btnShopping.addEventListener('click', () => setMode('shopping'));
  DOM.btnSettings.addEventListener('click', openSettingsModal);

  DOM.btnRewards.addEventListener('click', () => DOM.rewardsPanel.classList.toggle('open'));
  DOM.rewardsPanelClose.addEventListener('click', () => DOM.rewardsPanel.classList.remove('open'));

  DOM.rewardsDisplay.addEventListener('click', function(e) {
    if (e.target.classList.contains('account-copy-btn')) {
      copyToClipboard(e.target.dataset.phone);
    }
  });

  DOM.storeSelect.addEventListener('change', function() { setCurrentStore(this.value); });

  DOM.addForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const name = DOM.inputName.value.trim();
    if (!name) return;

    addItem(name, DOM.inputDepartment.value, DOM.inputAisle.value, DOM.inputAccount.value, DOM.inputCouponType.value);
    clearForm();
    DOM.inputName.focus();
  });

  DOM.quickDept.addEventListener('click', function(e) {
    if (e.target.classList.contains('quick-dept-btn')) {
      DOM.inputDepartment.value = e.target.dataset.dept;
      updateClearButtons();
      updateQuickDepartments();
    }
  });

  DOM.clearDept.addEventListener('click', () => { DOM.inputDepartment.value = ''; updateClearButtons(); updateQuickDepartments(); });
  DOM.clearAisle.addEventListener('click', () => { DOM.inputAisle.value = ''; updateClearButtons(); });
  DOM.inputDepartment.addEventListener('input', () => { updateClearButtons(); updateQuickDepartments(); });
  DOM.inputAisle.addEventListener('input', updateClearButtons);

  DOM.btnClear.addEventListener('click', function() {
    if (getCurrentItems().filter(i => i.status !== 'none').length === 0) return;
    if (confirm('Clear all selections?')) clearSelection();
  });

  DOM.listContainer.addEventListener('click', function(e) {
    const action = e.target.dataset.action;
    const id = e.target.dataset.id;
    if (!action || !id) return;

    if (action === 'toggle') cycleItemStatus(id);
    else if (action === 'edit') openEditModal(id);
    else if (action === 'delete' && confirm('Delete?')) deleteItem(id);
  });

  DOM.btnExport.addEventListener('click', exportData);
  DOM.btnImport.addEventListener('click', () => DOM.fileInput.click());
  DOM.fileInput.addEventListener('change', function(e) {
    if (e.target.files[0]) importData(e.target.files[0]);
    e.target.value = '';
  });

  // Edit Modal
  DOM.editModal.addEventListener('click', e => { if (e.target === DOM.editModal) closeEditModal(); });
  DOM.statusToggle.addEventListener('click', function(e) {
    const opt = e.target.closest('.status-option');
    if (opt) { editingStatus = opt.dataset.status; updateStatusToggle(); }
  });
  DOM.btnEditCancel.addEventListener('click', closeEditModal);
  DOM.btnEditSave.addEventListener('click', saveEdit);
  DOM.btnEditDelete.addEventListener('click', () => { if (editingItemId && confirm('Delete?')) deleteItem(editingItemId); });
  DOM.editModal.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
    else if (e.key === 'Escape') closeEditModal();
  });

  // Settings Modal
  DOM.settingsModal.addEventListener('click', e => { if (e.target === DOM.settingsModal) closeSettingsModal(); });
  DOM.btnSettingsClose.addEventListener('click', closeSettingsModal);

  document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', () => switchSettingsTab(tab.dataset.tab));
  });

  DOM.btnAddStore.addEventListener('click', () => {
    if (addStore(DOM.newStoreName.value)) DOM.newStoreName.value = '';
  });
  DOM.newStoreName.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); if (addStore(DOM.newStoreName.value)) DOM.newStoreName.value = ''; }
  });

  DOM.storeList.addEventListener('click', function(e) {
    const action = e.target.dataset.action;
    const store = e.target.dataset.store;
    if (action === 'select-store') setCurrentStore(store);
    else if (action === 'rename') openRenameModal(store);
    else if (action === 'delete-store') deleteStore(store);
  });

  DOM.btnAddAccount.addEventListener('click', () => {
    if (addAccount(DOM.newAccountPhone.value, DOM.newAccountLabel.value)) {
      DOM.newAccountPhone.value = '';
      DOM.newAccountLabel.value = '';
    }
  });

  DOM.accountsList.addEventListener('click', function(e) {
    const action = e.target.dataset.action;
    
    if (action === 'delete-account') {
      deleteAccount(e.target.dataset.id);
    } else if (action === 'delete-coupon') {
      deleteCoupon(e.target.dataset.account, parseInt(e.target.dataset.index));
    } else if (action === 'add-coupon') {
      const accId = e.target.dataset.account;
      const type = DOM.accountsList.querySelector('[data-coupon-type-for="' + accId + '"]').value;
      const name = DOM.accountsList.querySelector('[data-coupon-name-for="' + accId + '"]');
      const value = DOM.accountsList.querySelector('[data-coupon-value-for="' + accId + '"]');
      const min = DOM.accountsList.querySelector('[data-coupon-min-for="' + accId + '"]');
      const exp = DOM.accountsList.querySelector('[data-coupon-expires-for="' + accId + '"]');
      
      if (addCoupon(accId, type, name.value, value.value, min.value, exp.value)) {
        name.value = '';
        value.value = '';
        min.value = '';
        exp.value = '';
      }
    }
  });

  // Rename Modal
  DOM.renameModal.addEventListener('click', e => { if (e.target === DOM.renameModal) closeRenameModal(); });
  DOM.btnRenameCancel.addEventListener('click', closeRenameModal);
  DOM.btnRenameSave.addEventListener('click', saveRename);
  DOM.renameModal.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); saveRename(); }
    else if (e.key === 'Escape') closeRenameModal();
  });

  // === PWA Service Worker ===
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE_NAME = 'grocery-v4';
      const ASSETS = [self.location.href];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)).then(() => self.skipWaiting()));
      });
      self.addEventListener('activate', e => {
        e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))).then(() => self.clients.claim()));
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match(self.location.href))));
      });
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(() => {});
  }

  // === Initialize ===
  load();
  render();

})();
</script>

</body>
</html>
